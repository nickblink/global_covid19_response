---
title: "Testing coefficient effects on simulation"
author: "Nicholas Link"
date: "3/6/2023"
output: pdf_document
---
<!-- \usepackage{amsmath, amsfonts, amssymb} -->
<!-- \usepackage{fancyheadings, subfigure, vmargin, setspace, caption2} -->
<!-- \usepackage{epsfig, epsf, epic, graphicx} -->
<!-- \usepackage[dvips]{color} -->
<!-- \usepackage{natbib} -->
<!-- \newcommand*{\BFalpha}{\mbox{\mathversion{bold}$\alpha$}} -->
<!-- \newcommand*{\BFbeta}{\mbox{\mathversion{bold}$\beta$}} -->
<!-- \newcommand*{\BFgamma}{\mbox{\mathversion{bold}$\gamma$}} -->
<!-- \newcommand*{\BFtheta}{\mbox{\mathversion{bold}$\theta$}} -->


## Simulation setup


I will simulate data following the WF model for 20 facilities, with 3 separate groups of 4, 6, and 10 of them as neighbors (e.g. a facility in the first group has 3 neighbors and 16 non-neighbors). The data is generated using random sampling from a poisson regression with seasonal and temporal trends. We simulate the data with no spatial or temporal trends, with CAR-driven spatial and temporal trends, and with freqEpi spatial and temporal trends. We expect each model to do best when it is correctly specified under the DGP, so with multiple DGPs we can compare the robustness of models to mis-specification.


Situation 1:
All the $\beta$ values are sampled from the distributions below.

\begin{enumerate}
    \item $\beta_0 \sim N(4.3, 1)$
    \item $\beta_1 \sim N(-0.25, 0.26^2)$
    \item $\beta_2, ..., \beta_7 \sim N(0, 0.15^2)$
\end{enumerate}


Situation 2:
All the $\beta$ values are sampled from the distributions below.

\begin{enumerate}
    \item $\beta_0 \sim N(6, 1)$
    \item $\beta_1 \sim N(-0.25, 0.26^2)$
    \item $\beta_2, ..., \beta_7 \sim N(0, 0.15^2)$
\end{enumerate}

Situation 3:
For each facility, there is a 50\% chance they are sampled from either the first or second distribution.

\begin{enumerate}
    \item $\alpha \sim$ Bernoulli(0.5)
    \item If $\alpha = 0$, $\beta_0 \sim N(4.3, 1)$. If $\alpha = 1$, $\beta_0 \sim N(6, 1)$. 
    \item $\beta_1 \sim N(-0.25, 0.26^2)$
    \item $\beta_2, ..., \beta_7 \sim N(0, 0.15^2)$
\end{enumerate}

## Situation 1: beta0 = 4.3

```{r, echo = F, message = F, warning = F}

# defaultW <- getOption("warn") 

# options(warn = -1) 

library(MASS)
library(CARBayesST)
library(Matrix)
library(dplyr)
library(lubridate)
library(ggplot2)

setwd('C:/Users/Admin-Dell/Documents/github_projects/global_covid19_response')
source('R/imputation_functions.R')

```
```{r, echo = F, fig.height = 7}
inputs <- c('0.6', '4.3', 'n0.25', 'mcar', 'noST','10','50','test','25')

# pull parameters into proper format
p <- as.numeric(inputs[[1]])
b0_mean <- as.numeric(inputs[[2]])
b1_mean <- tryCatch({as.numeric(inputs[[3]])
}, warning = function(w){
  if(substr(inputs[[3]],1,1) == 'n'){
    return(-as.numeric(substr(inputs[[3]], 2, nchar(inputs[[3]]))))
  }
})
missingness <- tolower(inputs[[4]])
DGP <- tolower(inputs[[5]])
R <- as.integer(inputs[[6]])
num_jobs <- as.integer(inputs[[7]])
output_path <- tolower(inputs[[8]])
job_id <- as.integer(inputs[[9]])

lst <- simulate_data(district_sizes = c(4, 6, 10), R = R, end_date = '2020-12-01', b0_mean = b0_mean, b1_mean = b1_mean)

plot_facility_fits(lst[[1]], imp_vec = NULL)

begin_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2016-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

end_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2020-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

print(sprintf('The average starting value is %s and the average value at 01-01-2020 is %s', begin_mean, end_mean))
```

## Situation 2: b0 = 6
```{r, echo = F, fig.height = 7}
inputs <- c('0.6', '6', 'n0.25', 'mcar', 'noST','10','50','test','25')

# pull parameters into proper format
p <- as.numeric(inputs[[1]])
b0_mean <- as.numeric(inputs[[2]])
b1_mean <- tryCatch({as.numeric(inputs[[3]])
}, warning = function(w){
  if(substr(inputs[[3]],1,1) == 'n'){
    return(-as.numeric(substr(inputs[[3]], 2, nchar(inputs[[3]]))))
  }
})
missingness <- tolower(inputs[[4]])
DGP <- tolower(inputs[[5]])
R <- as.integer(inputs[[6]])
num_jobs <- as.integer(inputs[[7]])
output_path <- tolower(inputs[[8]])
job_id <- as.integer(inputs[[9]])

lst <- simulate_data(district_sizes = c(4, 6, 10), R = R, end_date = '2020-12-01', b0_mean = b0_mean, b1_mean = b1_mean)

plot_facility_fits(lst[[1]], imp_vec = NULL)

begin_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2016-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

end_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2020-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

print(sprintf('The average starting value is %s and the average value at 01-01-2020 is %s', begin_mean, end_mean))
```
## Situation 2: b0 = 6: b1 = 0
```{r, echo = F, fig.height = 7}
inputs <- c('0.6', '6', '0', 'mcar', 'noST','10','50','test','25')

# pull parameters into proper format
p <- as.numeric(inputs[[1]])
b0_mean <- as.numeric(inputs[[2]])
b1_mean <- tryCatch({as.numeric(inputs[[3]])
}, warning = function(w){
  if(substr(inputs[[3]],1,1) == 'n'){
    return(-as.numeric(substr(inputs[[3]], 2, nchar(inputs[[3]]))))
  }
})
missingness <- tolower(inputs[[4]])
DGP <- tolower(inputs[[5]])
R <- as.integer(inputs[[6]])
num_jobs <- as.integer(inputs[[7]])
output_path <- tolower(inputs[[8]])
job_id <- as.integer(inputs[[9]])

lst <- simulate_data(district_sizes = c(4, 6, 10), R = R, end_date = '2020-12-01', b0_mean = b0_mean, b1_mean = b1_mean)

plot_facility_fits(lst[[1]], imp_vec = NULL)

begin_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2016-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

end_mean = mean(unlist(sapply(1:R, function(ii) {
  res = lst$df_list[[ii]] %>% 
    filter(date == '2020-01-01') %>%
    summarize(mean(y))
  return(res)
})), na.rm = T)

print(sprintf('The average starting value is %s and the average value at 01-01-2020 is %s', begin_mean, end_mean))
```
